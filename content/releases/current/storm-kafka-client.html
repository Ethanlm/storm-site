<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <title>Storm Kafka Integration (0.10.x+)</title>

    <!-- Bootstrap core CSS -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap theme -->
    <link href="/assets/css/bootstrap-theme.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="http://fortawesome.github.io/Font-Awesome/assets/font-awesome/css/font-awesome.css">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/assets/css/owl.theme.css" rel="stylesheet">
    <link href="/assets/css/owl.carousel.css" rel="stylesheet">
    <script type="text/javascript" src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/owl.carousel.min.js"></script>
    <script type="text/javascript" src="/assets/js/storm.js"></script>
    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>


  <body>
    <header>
  <div class="container-fluid">
     <div class="row">
          <div class="col-md-5">
            <a href="/index.html"><img src="/images/logo.png" class="logo" /></a>
          </div>
          <div class="col-md-5">
            
              <h1>Version: 1.1.1</h1>
            
          </div>
          <div class="col-md-2">
            <a href="/downloads.html" class="btn-std btn-block btn-download">Download</a>
          </div>
        </div>
    </div>
</header>
<!--Header End-->
<!--Navigation Begin-->
<div class="navbar" role="banner">
  <div class="container-fluid">
      <div class="navbar-header">
          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>
        <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
          <ul class="nav navbar-nav">
              <li><a href="/index.html" id="home">Home</a></li>
                <li><a href="/getting-help.html" id="getting-help">Getting Help</a></li>
                <li><a href="/about/integrates.html" id="project-info">Project Information</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="documentation">Documentation <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                      
                        
                          <li><a href="/releases/2.0.0-SNAPSHOT/index.html">2.0.0-SNAPSHOT</a></li>
                        
                      
                        
                          <li><a href="/releases/1.1.1/index.html">1.1.1</a></li>
                        
                      
                        
                          <li><a href="/releases/1.1.0/index.html">1.1.0</a></li>
                        
                      
                        
                      
                        
                          <li><a href="/releases/1.0.4/index.html">1.0.4</a></li>
                        
                      
                        
                      
                        
                          <li><a href="/releases/1.0.3/index.html">1.0.3</a></li>
                        
                      
                        
                      
                        
                      
                        
                      
                        
                          <li><a href="/releases/0.10.2/index.html">0.10.2</a></li>
                        
                      
                        
                          <li><a href="/releases/0.10.1/index.html">0.10.1</a></li>
                        
                      
                        
                      
                        
                      
                        
                          <li><a href="/releases/0.9.7/index.html">0.9.7</a></li>
                        
                      
                        
                          <li><a href="/releases/0.9.6/index.html">0.9.6</a></li>
                        
                      
                        
                      
                        
                      
                        
                      
                        
                      
                        
                      
                    </ul>
                </li>
                <li><a href="/talksAndVideos.html">Talks and Slideshows</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="contribute">Community <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li><a href="/contribute/Contributing-to-Storm.html">Contributing</a></li>
                        <li><a href="/contribute/People.html">People</a></li>
                        <li><a href="/contribute/BYLAWS.html">ByLaws</a></li>
                    </ul>
                </li>
                <li><a href="/2017/09/15/storm105-released.html" id="news">News</a></li>
            </ul>
        </nav>
    </div>
</div>



    <div class="container-fluid">
    <h1 class="page-title">Storm Kafka Integration (0.10.x+)</h1>
          <div class="row">
           	<div class="col-md-12">
	             <!-- Documentation -->

<p class="post-meta"></p>

<h1 id="storm-apache-kafka-integration-using-the-kafka-client-jar">Storm Apache Kafka integration using the kafka-client jar</h1>

<p>This includes the new Apache Kafka consumer API.</p>

<h2 id="compatibility">Compatibility</h2>

<p>Apache Kafka versions 0.10 onwards</p>

<h2 id="writing-to-kafka-as-part-of-your-topology">Writing to Kafka as part of your topology</h2>

<p>You can create an instance of org.apache.storm.kafka.bolt.KafkaBolt and attach it as a component to your topology or if you
are using trident you can use org.apache.storm.kafka.trident.TridentState, org.apache.storm.kafka.trident.TridentStateFactory and
org.apache.storm.kafka.trident.TridentKafkaUpdater.</p>

<p>You need to provide implementations for the following 2 interfaces</p>

<h3 id="tupletokafkamapper-and-tridenttupletokafkamapper">TupleToKafkaMapper and TridentTupleToKafkaMapper</h3>

<p>These interfaces have 2 methods defined:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java">    <span class="n">K</span> <span class="nf">getKeyFromTuple</span><span class="p">(</span><span class="n">Tuple</span><span class="o">/</span><span class="n">TridentTuple</span> <span class="n">tuple</span><span class="o">);</span>
    <span class="n">V</span> <span class="n">getMessageFromTuple</span><span class="o">(</span><span class="n">Tuple</span><span class="o">/</span><span class="n">TridentTuple</span> <span class="n">tuple</span><span class="o">);</span>
</code></pre></div>
<p>As the name suggests, these methods are called to map a tuple to a Kafka key and a Kafka message. If you just want one field
as key and one field as value, then you can use the provided FieldNameBasedTupleToKafkaMapper.java
implementation. In the KafkaBolt, the implementation always looks for a field with field name &quot;key&quot; and &quot;message&quot; if you
use the default constructor to construct FieldNameBasedTupleToKafkaMapper for backward compatibility
reasons. Alternatively you could also specify a different key and message field by using the non default constructor.
In the TridentKafkaState you must specify what is the field name for key and message as there is no default constructor.
These should be specified while constructing an instance of FieldNameBasedTupleToKafkaMapper.</p>

<h3 id="kafkatopicselector-and-trident-kafkatopicselector">KafkaTopicSelector and trident KafkaTopicSelector</h3>

<p>This interface has only one method</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">KafkaTopicSelector</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">getTopics</span><span class="o">(</span><span class="n">Tuple</span><span class="o">/</span><span class="n">TridentTuple</span> <span class="n">tuple</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>The implementation of this interface should return the topic to which the tuple&#39;s key/message mapping needs to be published
You can return a null and the message will be ignored. If you have one static topic name then you can use
DefaultTopicSelector.java and set the name of the topic in the constructor.
<code>FieldNameTopicSelector</code> and <code>FieldIndexTopicSelector</code> can be used to select the topic should to publish a tuple to.
A user just needs to specify the field name or field index for the topic name in the tuple itself.
When the topic is name not found , the <code>Field*TopicSelector</code> will write messages into default topic .
Please make sure the default topic has been created .</p>

<h3 id="specifying-kafka-producer-properties">Specifying Kafka producer properties</h3>

<p>You can provide all the producer properties in your Storm topology by calling <code>KafkaBolt.withProducerProperties()</code> and <code>TridentKafkaStateFactory.withProducerProperties()</code>. Please see  <a href="http://kafka.apache.org/documentation.html#newproducerconfigs">http://kafka.apache.org/documentation.html#newproducerconfigs</a>
Section &quot;Important configuration properties for the producer&quot; for more details.
These are also defined in <code>org.apache.kafka.clients.producer.ProducerConfig</code></p>

<h3 id="using-wildcard-kafka-topic-match">Using wildcard kafka topic match</h3>

<p>You can do a wildcard topic match by adding the following config</p>
<div class="highlight"><pre><code class="language-" data-lang="">     Config config = new Config();
     config.put("kafka.topic.wildcard.match",true);

</code></pre></div>
<p>After this you can specify a wildcard topic for matching e.g. clickstream.*.log.  This will match all streams matching clickstream.my.log, clickstream.cart.log etc</p>

<h3 id="putting-it-all-together">Putting it all together</h3>

<p>For the bolt :</p>
<div class="highlight"><pre><code class="language-java" data-lang="java">        <span class="n">TopologyBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TopologyBuilder</span><span class="o">();</span>

        <span class="n">Fields</span> <span class="n">fields</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Fields</span><span class="o">(</span><span class="s">"key"</span><span class="o">,</span> <span class="s">"message"</span><span class="o">);</span>
        <span class="n">FixedBatchSpout</span> <span class="n">spout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FixedBatchSpout</span><span class="o">(</span><span class="n">fields</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span>
                    <span class="k">new</span> <span class="n">Values</span><span class="o">(</span><span class="s">"storm"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">),</span>
                    <span class="k">new</span> <span class="n">Values</span><span class="o">(</span><span class="s">"trident"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">),</span>
                    <span class="k">new</span> <span class="n">Values</span><span class="o">(</span><span class="s">"needs"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">),</span>
                    <span class="k">new</span> <span class="n">Values</span><span class="o">(</span><span class="s">"javadoc"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">)</span>
        <span class="o">);</span>
        <span class="n">spout</span><span class="o">.</span><span class="na">setCycle</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setSpout</span><span class="o">(</span><span class="s">"spout"</span><span class="o">,</span> <span class="n">spout</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>
        <span class="c1">//set producer properties.</span>
        <span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
        <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"bootstrap.servers"</span><span class="o">,</span> <span class="s">"localhost:9092"</span><span class="o">);</span>
        <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"acks"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">);</span>
        <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"key.serializer"</span><span class="o">,</span> <span class="s">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="o">);</span>
        <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"value.serializer"</span><span class="o">,</span> <span class="s">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="o">);</span>

        <span class="n">KafkaBolt</span> <span class="n">bolt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KafkaBolt</span><span class="o">()</span>
                <span class="o">.</span><span class="na">withProducerProperties</span><span class="o">(</span><span class="n">props</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withTopicSelector</span><span class="o">(</span><span class="k">new</span> <span class="n">DefaultTopicSelector</span><span class="o">(</span><span class="s">"test"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withTupleToKafkaMapper</span><span class="o">(</span><span class="k">new</span> <span class="n">FieldNameBasedTupleToKafkaMapper</span><span class="o">());</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="s">"forwardToKafka"</span><span class="o">,</span> <span class="n">bolt</span><span class="o">,</span> <span class="mi">8</span><span class="o">).</span><span class="na">shuffleGrouping</span><span class="o">(</span><span class="s">"spout"</span><span class="o">);</span>

        <span class="n">Config</span> <span class="n">conf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Config</span><span class="o">();</span>

        <span class="n">StormSubmitter</span><span class="o">.</span><span class="na">submitTopology</span><span class="o">(</span><span class="s">"kafkaboltTest"</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">createTopology</span><span class="o">());</span>
</code></pre></div>
<p>For Trident:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java">        <span class="n">Fields</span> <span class="n">fields</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Fields</span><span class="o">(</span><span class="s">"word"</span><span class="o">,</span> <span class="s">"count"</span><span class="o">);</span>
        <span class="n">FixedBatchSpout</span> <span class="n">spout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FixedBatchSpout</span><span class="o">(</span><span class="n">fields</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Values</span><span class="o">(</span><span class="s">"storm"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">Values</span><span class="o">(</span><span class="s">"trident"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">Values</span><span class="o">(</span><span class="s">"needs"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">Values</span><span class="o">(</span><span class="s">"javadoc"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">)</span>
        <span class="o">);</span>
        <span class="n">spout</span><span class="o">.</span><span class="na">setCycle</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

        <span class="n">TridentTopology</span> <span class="n">topology</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TridentTopology</span><span class="o">();</span>
        <span class="n">Stream</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">topology</span><span class="o">.</span><span class="na">newStream</span><span class="o">(</span><span class="s">"spout1"</span><span class="o">,</span> <span class="n">spout</span><span class="o">);</span>

        <span class="c1">//set producer properties.</span>
        <span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
        <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"bootstrap.servers"</span><span class="o">,</span> <span class="s">"localhost:9092"</span><span class="o">);</span>
        <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"acks"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">);</span>
        <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"key.serializer"</span><span class="o">,</span> <span class="s">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="o">);</span>
        <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"value.serializer"</span><span class="o">,</span> <span class="s">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="o">);</span>

        <span class="n">TridentKafkaStateFactory</span> <span class="n">stateFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TridentKafkaStateFactory</span><span class="o">()</span>
                <span class="o">.</span><span class="na">withProducerProperties</span><span class="o">(</span><span class="n">props</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withKafkaTopicSelector</span><span class="o">(</span><span class="k">new</span> <span class="n">DefaultTopicSelector</span><span class="o">(</span><span class="s">"test"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">withTridentTupleToKafkaMapper</span><span class="o">(</span><span class="k">new</span> <span class="n">FieldNameBasedTupleToKafkaMapper</span><span class="o">(</span><span class="s">"word"</span><span class="o">,</span> <span class="s">"count"</span><span class="o">));</span>
        <span class="n">stream</span><span class="o">.</span><span class="na">partitionPersist</span><span class="o">(</span><span class="n">stateFactory</span><span class="o">,</span> <span class="n">fields</span><span class="o">,</span> <span class="k">new</span> <span class="n">TridentKafkaStateUpdater</span><span class="o">(),</span> <span class="k">new</span> <span class="n">Fields</span><span class="o">());</span>

        <span class="n">Config</span> <span class="n">conf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Config</span><span class="o">();</span>
        <span class="n">StormSubmitter</span><span class="o">.</span><span class="na">submitTopology</span><span class="o">(</span><span class="s">"kafkaTridentTest"</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span> <span class="n">topology</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
</code></pre></div>
<h2 id="reading-from-kafka-spouts">Reading From kafka (Spouts)</h2>

<h3 id="configuration">Configuration</h3>

<p>The spout implementations are configured by use of the <code>KafkaSpoutConfig</code> class.  This class uses a Builder pattern and can be started either by calling one of
the Builders constructors or by calling the static method builder in the KafkaSpoutConfig class.</p>

<p>The Constructor or static method to create the builder require a few key values (that can be changed later on) but are the minimum config needed to start
a spout.</p>

<p><code>bootstrapServers</code> is the same as the Kafka Consumer Property &quot;bootstrap.servers&quot;.
<code>topics</code> The topics the spout will consume can either be a <code>Collection</code> of specific topic names (1 or more) or a regular expression <code>Pattern</code>, which specifies
that any topics that match that regular expression will be consumed.</p>

<p>In the case of the Constructors you may also need to specify a key deserializer and a value deserializer.  This is to help guarantee type safety through the use
of Java generics.  The defaults are <code>StringDeserializer</code>s and can be overwritten by calling <code>setKeyDeserializer</code> and/or <code>setValueDeserializer</code>.
If these are set to null the code will fall back to what is set in the kafka properties, but it is preferable to be explicit here, again to maintain 
type safety with the generics.</p>

<p>There are a few key configs to pay attention to.</p>

<p><code>setFirstPollOffsetStrategy</code> allows you to set where to start consuming data from.  This is used both in case of failure recovery and starting the spout
for the first time. Allowed values include</p>

<ul>
<li><code>EARLIEST</code> means that the kafka spout polls records starting in the first offset of the partition, regardless of previous commits</li>
<li><code>LATEST</code> means that the kafka spout polls records with offsets greater than the last offset in the partition, regardless of previous commits</li>
<li><code>UNCOMMITTED_EARLIEST</code> (DEFAULT) means that the kafka spout polls records from the last committed offset, if any. If no offset has been committed, it behaves as <code>EARLIEST</code>.</li>
<li><code>UNCOMMITTED_LATEST</code> means that the kafka spout polls records from the last committed offset, if any. If no offset has been committed, it behaves as <code>LATEST</code>.</li>
</ul>

<p><code>setRecordTranslator</code> allows you to modify how the spout converts a Kafka Consumer Record into a Tuple, and which stream that tuple will be published into.
By default the &quot;topic&quot;, &quot;partition&quot;, &quot;offset&quot;, &quot;key&quot;, and &quot;value&quot; will be emitted to the &quot;default&quot; stream.  If you want to output entries to different
streams based on the topic, storm provides <code>ByTopicRecordTranslator</code>.  See below for more examples on how to use these.</p>

<p><code>setProp</code> can be used to set kafka properties that do not have a convenience method.</p>

<p><code>setGroupId</code> lets you set the id of the kafka consumer group property &quot;group.id&#39;</p>

<p><code>setSSLKeystore</code> and <code>setSSLTruststore</code> allow you to configure SSL authentication.</p>

<h3 id="usage-examples">Usage Examples</h3>

<p>The API is written with java 8 lambda expressions in mind.  It works with java7 and below though.</p>

<h4 id="create-a-simple-insecure-spout">Create a Simple Insecure Spout</h4>

<p>The following will consume all events published to &quot;topic&quot; and send them to MyBolt with the fields &quot;topic&quot;, &quot;partition&quot;, &quot;offset&quot;, &quot;key&quot;, &quot;value&quot;.</p>
<div class="highlight"><pre><code class="language-java" data-lang="java">
<span class="kd">final</span> <span class="n">TopologyBuilder</span> <span class="n">tp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TopologyBuilder</span><span class="o">();</span>
<span class="n">tp</span><span class="o">.</span><span class="na">setSpout</span><span class="o">(</span><span class="s">"kafka_spout"</span><span class="o">,</span> <span class="k">new</span> <span class="n">KafkaSpout</span><span class="o">&lt;&gt;(</span><span class="n">KafkaSpoutConfig</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="s">"127.0.0.1:"</span> <span class="o">+</span> <span class="n">port</span><span class="o">,</span> <span class="s">"topic"</span><span class="o">).</span><span class="na">build</span><span class="o">()),</span> <span class="mi">1</span><span class="o">);</span>
<span class="n">tp</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="s">"bolt"</span><span class="o">,</span> <span class="k">new</span> <span class="n">myBolt</span><span class="o">()).</span><span class="na">shuffleGrouping</span><span class="o">(</span><span class="s">"kafka_spout"</span><span class="o">);</span>
<span class="o">...</span>
</code></pre></div>
<h4 id="wildcard-topics">Wildcard Topics</h4>

<p>Wildcard topics will consume from all topics that exist in the specified brokers list and match the pattern.  So in the following example
&quot;topic&quot;, &quot;topic_foo&quot; and &quot;topic_bar&quot; will all match the pattern &quot;topic.*&quot;, but &quot;not_my_topic&quot; would not match. </p>
<div class="highlight"><pre><code class="language-java" data-lang="java">
<span class="kd">final</span> <span class="n">TopologyBuilder</span> <span class="n">tp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TopologyBuilder</span><span class="o">();</span>
<span class="n">tp</span><span class="o">.</span><span class="na">setSpout</span><span class="o">(</span><span class="s">"kafka_spout"</span><span class="o">,</span> <span class="k">new</span> <span class="n">KafkaSpout</span><span class="o">&lt;&gt;(</span><span class="n">KafkaSpoutConfig</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="s">"127.0.0.1:"</span> <span class="o">+</span> <span class="n">port</span><span class="o">,</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"topic.*"</span><span class="o">)).</span><span class="na">build</span><span class="o">()),</span> <span class="mi">1</span><span class="o">);</span>
<span class="n">tp</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="s">"bolt"</span><span class="o">,</span> <span class="k">new</span> <span class="n">myBolt</span><span class="o">()).</span><span class="na">shuffleGrouping</span><span class="o">(</span><span class="s">"kafka_spout"</span><span class="o">);</span>
<span class="o">...</span>
</code></pre></div>
<h4 id="multiple-streams">Multiple Streams</h4>

<p>This uses java 8 lambda expressions.</p>

<p>final TopologyBuilder tp = new TopologyBuilder();</p>

<p>//By default all topics not covered by another rule, but consumed by the spout will be emitted to &quot;STREAM_1&quot; as &quot;topic&quot;, &quot;key&quot;, and &quot;value&quot;
ByTopicRecordTranslator<String, String> byTopic = new ByTopicRecordTranslator&lt;&gt;(
    (r) -&gt; new Values(r.topic(), r.key(), r.value()),
    new Fields(&quot;topic&quot;, &quot;key&quot;, &quot;value&quot;), &quot;STREAM_1&quot;);
//For topic_2 all events will be emitted to &quot;STREAM_2&quot; as just &quot;key&quot; and &quot;value&quot;
byTopic.forTopic(&quot;topic_2&quot;, (r) -&gt; new Values(r.key(), r.value()), new Fields(&quot;key&quot;, &quot;value&quot;), &quot;STREAM_2&quot;);</p>

<p>tp.setSpout(&quot;kafka_spout&quot;, new KafkaSpout&lt;&gt;(KafkaSpoutConfig.builder(&quot;127.0.0.1:&quot; + port, &quot;topic_1&quot;, &quot;topic_2&quot;, &quot;topic_3&quot;).build()), 1);
tp.setBolt(&quot;bolt&quot;, new myBolt()).shuffleGrouping(&quot;kafka_spout&quot;, &quot;STREAM_1&quot;);
tp.setBolt(&quot;another&quot;, new myOtherBolt()).shuffleGrouping(&quot;kafka_spout&quot;, &quot;STREAM_2&quot;);
...
```</p>

<h4 id="trident">Trident</h4>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="n">TridentTopology</span> <span class="n">tridentTopology</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TridentTopology</span><span class="o">();</span>
<span class="kd">final</span> <span class="n">Stream</span> <span class="n">spoutStream</span> <span class="o">=</span> <span class="n">tridentTopology</span><span class="o">.</span><span class="na">newStream</span><span class="o">(</span><span class="s">"kafkaSpout"</span><span class="o">,</span>
    <span class="k">new</span> <span class="n">KafkaTridentSpoutOpaque</span><span class="o">&lt;&gt;(</span><span class="n">KafkaSpoutConfig</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="s">"127.0.0.1:"</span> <span class="o">+</span> <span class="n">port</span><span class="o">,</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"topic.*"</span><span class="o">)).</span><span class="na">build</span><span class="o">()))</span>
      <span class="o">.</span><span class="na">parallelismHint</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="o">...</span>
</code></pre></div>
<p>Trident does not support multiple streams and will ignore any streams set for output.  If however the Fields are not identical for each
output topic it will throw an exception and not continue.</p>

<h3 id="custom-recordtranslators-advanced">Custom RecordTranslators (ADVANCED)</h3>

<p>In most cases the built in SimpleRecordTranslator and ByTopicRecordTranslator should cover your use case.  If you do run into a situation where you need a custom one
then this documentation will describe how to do this properly, and some of the less than obvious classes involved.</p>

<p>The point of apply is to take a ConsumerRecord and turn it into a <code>List&lt;Object&gt;</code> that can be emitted.  What is not obvious is how to tell the spout to emit it to a
specific stream.  To do this you will need to return an instance of <code>org.apache.storm.kafka.spout.KafkaTuple</code>.  This provides a method <code>routedTo</code> that will say which
specific stream the tuple should go to.</p>

<p>For Example:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">return</span> <span class="k">new</span> <span class="nf">KafkaTuple</span><span class="p">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">).</span><span class="na">routedTo</span><span class="o">(</span><span class="s">"bar"</span><span class="o">);</span>
</code></pre></div>
<p>Will cause the tuple to be emitted on the &quot;bar&quot; stream.</p>

<p>Be careful when writing custom record translators because just like in a storm spout it needs to be self consistent.  The <code>streams</code> method should return
a full set of streams that this translator will ever try to emit on.  Additionally <code>getFieldsFor</code> should return a valid Fields object for each of those
streams.  If you are doing this for Trident a value must be in the List returned by apply for every field in the Fields object for that stream,
otherwise trident can throw exceptions.</p>

<h3 id="manual-partition-control-advanced">Manual Partition Control (ADVANCED)</h3>

<p>By default Kafka will automatically assign partitions to the current set of spouts.  It handles lots of things, but in some cases you may want to manually assign the partitions.
This can cause less churn in the assignments when spouts go down and come back up, but it can result in a lot of issues if not done right.  This can all be handled by subclassing
Subscription and we have a few implementations that you can look at for examples on how to do this.  ManualPartitionNamedSubscription and ManualPartitionPatternSubscription.  Again
please be careful when using these or implementing your own.</p>

<h2 id="use-the-maven-shade-plugin-to-build-the-uber-jar">Use the Maven Shade Plugin to Build the Uber Jar</h2>

<p>Add the following to <code>REPO_HOME/storm/external/storm-kafka-client/pom.xml</code></p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;plugin&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>maven-shade-plugin<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.4.1<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;executions&gt;</span>
        <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
                <span class="nt">&lt;goal&gt;</span>shade<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
                <span class="nt">&lt;transformers&gt;</span>
                    <span class="nt">&lt;transformer</span> <span class="na">implementation=</span><span class="s">"org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;mainClass&gt;</span>org.apache.storm.kafka.spout.test.KafkaSpoutTopologyMain<span class="nt">&lt;/mainClass&gt;</span>
                    <span class="nt">&lt;/transformer&gt;</span>
                <span class="nt">&lt;/transformers&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
        <span class="nt">&lt;/execution&gt;</span>
    <span class="nt">&lt;/executions&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</code></pre></div>
<p>create the uber jar by running the command:</p>

<p><code>mvn package -f REPO_HOME/storm/external/storm-kafka-client/pom.xml</code></p>

<p>This will create the uber jar file with the name and location matching the following pattern:</p>

<p><code>REPO_HOME/storm/external/storm-kafka-client/target/storm-kafka-client-1.0.x.jar</code></p>

<h3 id="run-storm-topology">Run Storm Topology</h3>

<p>Copy the file <code>REPO_HOME/storm/external/storm-kafka-client/target/storm-kafka-client-*.jar</code> to <code>STORM_HOME/extlib</code></p>

<p>Using the Kafka command line tools create three topics [test, test1, test2] and use the Kafka console producer to populate the topics with some data </p>

<p>Execute the command <code>STORM_HOME/bin/storm jar REPO_HOME/storm/external/storm/target/storm-kafka-client-*.jar org.apache.storm.kafka.spout.test.KafkaSpoutTopologyMain</code></p>

<p>With the debug level logs enabled it is possible to see the messages of each topic being redirected to the appropriate Bolt as defined 
by the streams defined and choice of shuffle grouping.   </p>

<h2 id="using-storm-kafka-client-with-different-versions-of-kafka">Using storm-kafka-client with different versions of kafka</h2>

<p>Storm-kafka-client&#39;s Kafka dependency is defined as <code>provided</code> scope in maven, meaning it will not be pulled in
as a transitive dependency. This allows you to use a version of Kafka dependency compatible with your kafka cluster.</p>

<p>When building a project with storm-kafka-client, you must explicitly add the Kafka clients dependency. For example, to
use Kafka-clients 0.10.0.0, you would use the following dependency in your <code>pom.xml</code>:</p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml">        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.kafka<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>kafka-clients<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>0.10.0.0<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>
<p>You can also override the kafka clients version while building from maven, with parameter <code>storm.kafka.client.version</code>
e.g. <code>mvn clean install -Dstorm.kafka.client.version=0.10.0.0</code></p>

<p>When selecting a kafka client version, you should ensure - 
 1. kafka api is compatible. storm-kafka-client module only supports <strong>0.10 or newer</strong> kafka client API. For older versions,
 you can use storm-kafka module (<a href="https://github.com/apache/storm/tree/master/external/storm-kafka">https://github.com/apache/storm/tree/master/external/storm-kafka</a>).<br>
 2. The kafka client selected by you should be wire compatible with the broker. e.g. 0.9.x client will not work with 
 0.8.x broker. </p>

<h1 id="kafka-spout-performance-tuning">Kafka Spout Performance Tuning</h1>

<p>The Kafka spout provides two internal parameters to control its performance. The parameters can be set using the <a href="https://github.com/apache/storm/blob/1.0.x-branch/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpoutConfig.java">KafkaSpoutConfig</a> methods <a href="https://github.com/apache/storm/blob/1.0.x-branch/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpoutConfig.java#L189-L193">setOffsetCommitPeriodMs</a> and <a href="https://github.com/apache/storm/blob/1.0.x-branch/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpoutConfig.java#L211-L217">setMaxUncommittedOffsets</a>. </p>

<ul>
<li>&quot;offset.commit.period.ms&quot; controls how often the spout commits to Kafka</li>
<li>&quot;max.uncommitted.offsets&quot; controls how many offsets can be pending commit before another poll can take place
<br/></li>
</ul>

<p>The <a href="http://kafka.apache.org/documentation.html#consumerconfigs">Kafka consumer config</a> parameters may also have an impact on the performance of the spout. The following Kafka parameters are likely the most influential in the spout performance: </p>

<ul>
<li>“fetch.min.bytes”</li>
<li>“fetch.max.wait.ms”</li>
<li><a href="http://kafka.apache.org/090/javadoc/index.html?org/apache/kafka/clients/consumer/KafkaConsumer.html">Kafka Consumer</a> instance poll timeout, which is specified for each Kafka spout using the <a href="https://github.com/apache/storm/blob/1.0.x-branch/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpoutConfig.java">KafkaSpoutConfig</a> method <a href="https://github.com/apache/storm/blob/1.0.x-branch/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpoutConfig.java#L180-L184">setPollTimeoutMs</a>
<br/></li>
</ul>

<p>Depending on the structure of your Kafka cluster, distribution of the data, and availability of data to poll, these parameters will have to be configured appropriately. Please refer to the Kafka documentation on Kafka parameter tuning.</p>

<h3 id="default-values">Default values</h3>

<p>Currently the Kafka spout has has the following default values, which have shown to give good performance in the test environment as described in this <a href="https://hortonworks.com/blog/microbenchmarking-storm-1-0-performance/">blog post</a></p>

<ul>
<li>poll.timeout.ms = 200</li>
<li>offset.commit.period.ms = 30000   (30s)</li>
<li>max.uncommitted.offsets = 10000000
<br/></li>
</ul>

<h1 id="kafka-autocommitmode">Kafka AutoCommitMode</h1>

<p>If reliability isn&#39;t important to you -- that is, you don&#39;t care about losing tuples in failure situations --, and want to remove the overhead of tuple tracking, then you can run a KafkaSpout with AutoCommitMode.</p>

<p>To enable it, you need to:
* set Config.TOPOLOGY_ACKERS to 0;
* enable <em>AutoCommitMode</em> in Kafka consumer configuration; </p>

<p>Here&#39;s one example to set AutoCommitMode in KafkaSpout:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">KafkaSpoutConfig</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">kafkaConf</span> <span class="o">=</span> <span class="n">KafkaSpoutConfig</span>
        <span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="n">String</span> <span class="n">bootstrapServers</span><span class="o">,</span> <span class="n">String</span> <span class="o">...</span> <span class="n">topics</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setProp</span><span class="o">(</span><span class="n">ConsumerConfig</span><span class="o">.</span><span class="na">ENABLE_AUTO_COMMIT_CONFIG</span><span class="o">,</span> <span class="s">"true"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setFirstPollOffsetStrategy</span><span class="o">(</span><span class="n">FirstPollOffsetStrategy</span><span class="o">.</span><span class="na">EARLIEST</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div>
<p><em>Note that it&#39;s not exactly At-Most-Once in Storm, as offset is committed periodically by Kafka consumer, some tuples could be replayed when KafkaSpout is crashed.</em></p>



	          </div>
	       </div>
	  </div>
<footer>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>Meetups</h5>
                    <ul class="latest-news">
                        
                        <li><a href="http://www.meetup.com/Apache-Storm-Apache-Kafka/">Apache Storm & Apache Kafka</a> <span class="small">(Sunnyvale, CA)</span></li>
                        
                        <li><a href="http://www.meetup.com/Apache-Storm-Kafka-Users/">Apache Storm & Kafka Users</a> <span class="small">(Seattle, WA)</span></li>
                        
                        <li><a href="http://www.meetup.com/New-York-City-Storm-User-Group/">NYC Storm User Group</a> <span class="small">(New York, NY)</span></li>
                        
                        <li><a href="http://www.meetup.com/Bay-Area-Stream-Processing">Bay Area Stream Processing</a> <span class="small">(Emeryville, CA)</span></li>
                        
                        <li><a href="http://www.meetup.com/Boston-Storm-Users/">Boston Realtime Data</a> <span class="small">(Boston, MA)</span></li>
                        
                        <li><a href="http://www.meetup.com/storm-london">London Storm User Group</a> <span class="small">(London, UK)</span></li>
                        
                        <!-- <li><a href="http://www.meetup.com/Apache-Storm-Kafka-Users/">Seatle, WA</a> <span class="small">(27 Jun 2015)</span></li> -->
                    </ul>
                </div>
            </div>
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>About Storm</h5>
                    <p>Storm integrates with any queueing system and any database system. Storm's spout abstraction makes it easy to integrate a new queuing system. Likewise, integrating Storm with database systems is easy.</p>
               </div>
            </div>
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>First Look</h5>
                    <ul class="footer-list">
                        <li><a href="/releases/current/Rationale.html">Rationale</a></li>
                        <li><a href="/releases/current/Tutorial.html">Tutorial</a></li>
                        <li><a href="/releases/current/Setting-up-development-environment.html">Setting up development environment</a></li>
                        <li><a href="/releases/current/Creating-a-new-Storm-project.html">Creating a new Storm project</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-md-3">
                <div class="footer-widget">
                    <h5>Documentation</h5>
                    <ul class="footer-list">
                        <li><a href="/releases/current/index.html">Index</a></li>
                        <li><a href="/releases/current/javadocs/index.html">Javadoc</a></li>
                        <li><a href="/releases/current/FAQ.html">FAQ</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <hr/>
        <div class="row">   
            <div class="col-md-12">
                <p align="center">Copyright © 2015 <a href="http://www.apache.org">Apache Software Foundation</a>. All Rights Reserved. 
                    <br>Apache Storm, Apache, the Apache feather logo, and the Apache Storm project logos are trademarks of The Apache Software Foundation. 
                    <br>All other marks mentioned may be trademarks or registered trademarks of their respective owners.</p>
            </div>
        </div>
    </div>
</footer>
<!--Footer End-->
<!-- Scroll to top -->
<span class="totop"><a href="#"><i class="fa fa-angle-up"></i></a></span> 

</body>

</html>

